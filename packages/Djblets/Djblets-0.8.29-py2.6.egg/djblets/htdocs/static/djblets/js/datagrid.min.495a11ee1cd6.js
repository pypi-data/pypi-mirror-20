(function(){(function($){$.fn.datagrid=function(options){var $grid=this,gridId=this.attr("id"),$menu=$("#"+gridId+"-menu"),$gridContainer=$grid.find(".datagrid"),$bodyContainer=$gridContainer.find(".datagrid-body-container"),$headTable=$gridContainer.find(".datagrid-head"),$bodyTable=$bodyContainer.find(".datagrid-body"),$bodyTableHead=$bodyTable.find("thead"),$paginator=$gridContainer.find(".paginator"),$window=$(window),$editButton,storedColWidths=[],activeColumns=[],$activeMenu=null,columnMidpoints=[],dragColumn=null,dragColumnsChanged=false,dragColumnWidth=0,dragIndex=0,dragLastX=0,lastWindowWidth;options=options||{};this.reload=function(){loadFromServer(null,true)};this.resizeToFit=function(){$bodyContainer.height($grid.innerHeight()-$bodyContainer.position().top-($paginator.outerHeight()||0));syncColumnSizes()};function setupHeader(){var $origHeader=$bodyTable.find("thead");$bodyTable.find("colgroup col").each(function(i,colEl){storedColWidths.push(colEl.width)});$headTable.find("thead").remove().end().append($origHeader.clone().show());$origHeader.hide();activeColumns=[];$headTable.find("col").not(".datagrid-customize").each(function(i,col){activeColumns.push(col.className)});$headTable.find("th").disableSelection().not(".edit-columns").draggable({appendTo:"body",axis:"x",containment:$headTable.find("thead:first"),cursor:"move",helper:function(){var $el=$(this);return $("<div/>").addClass("datagrid-header-drag datagrid-header").width($el.width()).height($el.height()).css("top",$el.offset().top).html($el.html())},start:startColumnDrag,stop:endColumnDrag,drag:onColumnDrag});$editButton=$("#"+gridId+"-edit").click(function(evt){evt.stopPropagation();toggleColumnsMenu()});$headTable.find(".datagrid-header-checkbox").change(function(){var $checkbox=$(this),colName=$checkbox.data("checkbox-name");$bodyTable.find('tbody input[data-checkbox-name="'+colName+'"]').prop("checked",$checkbox.prop("checked")).change()})}function syncColumnSizes(){var origHeaderCells=$bodyTableHead[0].rows[0].cells,$fixedCols=$headTable.find("colgroup col"),$origCols=$bodyTable.find("colgroup col"),numCols=origHeaderCells.length,bodyWidths=[],headWidths=[],extraWidth=0,width,i;for(i=0;i<numCols;i++){$origCols[i].width=storedColWidths[i]}$bodyTableHead.show();$headTable.width($bodyContainer.width()-1);extraWidth=$bodyContainer.width()-$bodyTable.width();for(i=0;i<numCols;i++){width=$(origHeaderCells[i]).outerWidth();bodyWidths.push(width);headWidths.push(width)}$bodyTableHead.hide();headWidths[numCols-1]=bodyWidths[numCols-1]-1;headWidths[numCols-2]=bodyWidths[numCols-2]-1+extraWidth;for(i=0;i<numCols;i++){$origCols[i].width=bodyWidths[i];$fixedCols[i].width=headWidths[i]}}function onResize(){var windowWidth=$window.width();if(windowWidth!==lastWindowWidth){lastWindowWidth=windowWidth;syncColumnSizes()}}function loadFromServer(params,reloadGrid){var search=window.location.search||"?",url=window.location.pathname+search+"&gridonly=1&datagrid-id="+gridId;if(params){url+="&"+params}$.get(url,function(html){if(reloadGrid){$grid.replaceWith(html);$grid=$("#"+gridId).datagrid()}else{setupHeader()}$grid.trigger("reloaded")})}function hideColumnsMenu(){if($activeMenu!==null){$activeMenu.hide();$activeMenu=null}}function toggleColumnsMenu(){var offset;if($menu.is(":visible")){hideColumnsMenu()}else{offset=$editButton.position();$menu.css({left:offset.left-$menu.outerWidth()+$editButton.outerWidth(),top:offset.top+$editButton.outerHeight()}).show();$activeMenu=$menu}}function saveColumns(columnsStr,reloadGrid){loadFromServer("columns="+columnsStr,reloadGrid)}function toggleColumn(columnId){saveColumns(serializeColumns(columnId),true)}function serializeColumns(addedColumn){var columnsStr="";$(activeColumns).each(function(i){var curColumn=activeColumns[i];if(curColumn===addedColumn){addedColumn=null}else{columnsStr+=curColumn;if(i<activeColumns.length-1){columnsStr+=","}}});if(addedColumn){columnsStr+=","+addedColumn}return columnsStr}function startColumnDrag(evt,ui){dragColumn=this;dragColumnsChanged=false;dragColumnWidth=ui.helper.width();dragIndex=0;dragLastX=0;buildColumnInfo();$(dragColumn).css("visibility","hidden")}function endColumnDrag(){var $column=$(this);$column.css("visibility","visible");columnMidpoints=[];if(dragColumnsChanged){saveColumns(serializeColumns())}}function onColumnDrag(e,ui){var x=e.originalEvent.pageX,hitX=-1,index=-1;if(x===dragLastX){return}if(x<dragLastX){index=dragIndex-1;hitX=ui.offset.left}else{index=dragIndex+1;hitX=ui.offset.left+ui.helper.width()}if(index>=0&&index<columnMidpoints.length){if(x<dragLastX&&hitX<=columnMidpoints[index]){swapColumnBefore(dragIndex,index)}else if(x>dragLastX&&hitX>=columnMidpoints[index]){swapColumnBefore(index,dragIndex)}}dragLastX=x}function buildColumnInfo(){columnMidpoints=[];$headTable.find("th").not(".edit-columns").each(function(i,column){var $column=$(column),offset=$column.offset();if(column===dragColumn){dragIndex=i;width=dragColumnWidth}else{width=$column.width()}columnMidpoints.push(Math.round(offset.left+width/2))})}function swapColumnBefore(index,beforeIndex){var temp;temp=activeColumns[index];activeColumns[index]=activeColumns[beforeIndex];activeColumns[beforeIndex]=temp;swapColumns($bodyTable[0],beforeIndex,index);swapColumns($headTable[0],beforeIndex,index);temp=storedColWidths[index];storedColWidths[index]=storedColWidths[beforeIndex];storedColWidths[beforeIndex]=temp;dragColumnsChanged=true;buildColumnInfo()}function swapColumns(table,beforeIndex,index){var beforeCell,tempColSpan,colTags=$(table).find("colgroup col"),row,cell,rowsLen,i;colTags.eq(index).insertBefore(colTags.eq(beforeIndex));for(i=0,rowsLen=table.rows.length;i<rowsLen;i++){row=table.rows[i];cell=row.cells[index];beforeCell=row.cells[beforeIndex];row.insertBefore(cell,beforeCell);tempColSpan=cell.colSpan;cell.colSpan=beforeCell.colSpan;beforeCell.colSpan=tempColSpan}}$grid.data("datagrid",this);setupHeader();$menu.find("tr").each(function(i,row){var className=row.className;$(row).find(".datagrid-menu-checkbox, .datagrid-menu-label a").click(function(){toggleColumn(className)})});$(document.body).click(hideColumnsMenu);$window.resize(onResize);onResize();return $grid};$(document).ready(function(){$("div.datagrid-wrapper").datagrid()})})(jQuery)}).call(this);