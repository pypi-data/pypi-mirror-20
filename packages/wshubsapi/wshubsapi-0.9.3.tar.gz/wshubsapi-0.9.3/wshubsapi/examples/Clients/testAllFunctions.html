<!DOCTYPE html>
<!--suppress ALL -->
<html>
<head>
    <title>tornado WebSocket example</title>
    <!--File auto-generated by the server.
    Path needs to match with Hub.constructJSFile path parameter-->
    <script type="text/javascript" src="_static/WSHubsApi.js"></script>
    <link rel="stylesheet" type="text/css" href="_static/WSHubsApi.css"></link>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.4.2.js"></script>
</head>
<body>
<div class="container">
    <h1>Test all hubs functions</h1>
</div>
<script>
    var hubsApi = new HubsAPI('ws://127.0.0.1:8888/');
    hubsApi.connect(0.1);

    var STRIP_COMMENTS = /(\/\/.*$)|(\/\*[\s\S]*?\*\/)|(\s*=[^,\)]*(('(?:\\'|[^'\r\n])*')|("(?:\\"|[^"\r\n])*"))|(\s*=[^,\)]*))/mg;
    var ARGUMENT_NAMES = /([^\s,]+)/g;
    function getParamNames(func) {
        var fnStr = func.toString().replace(STRIP_COMMENTS, '');
        var result = fnStr.slice(fnStr.indexOf('(') + 1, fnStr.indexOf(')')).match(ARGUMENT_NAMES);
        if (result === null)
            result = [];
        return result;
    }

    function syntaxHighlight(json) {
        json = JSON.stringify(arguments, null, 2)
        json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
            var cls = 'number';
            if (/^"/.test(match)) {
                if (/:$/.test(match)) {
                    cls = 'key';
                } else {
                    cls = 'string';
                }
            } else if (/true|false/.test(match)) {
                cls = 'boolean';
            } else if (/null/.test(match)) {
                cls = 'null';
            }
            return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function getSortedElements(object) {
        var elements = [];
        for (var element in object) {
            if(object.hasOwnProperty(element)){
                elements.push(element);
            }
        }
        return elements.sort();
    }

    var resultPreElement = document.createElement('pre');

    function output(inp, element) {
        inp = syntaxHighlight(inp);
        resultPreElement.innerHTML = inp;
    }

    var hubsInfo = {}
    for (hubName in hubsApi) {
        if (hubsApi.hasOwnProperty(hubName) && hubsApi[hubName] && hubsApi[hubName].server && hubsApi[hubName].server.__HUB_NAME) {
            var hubServer = hubsApi[hubName].server;
            hubsInfo[hubServer.__HUB_NAME] = {};
            for (fun in hubServer) {
                if (hubServer.hasOwnProperty(fun) && typeof hubServer[fun] === 'function') {
                    hubsInfo[hubServer.__HUB_NAME][fun] = {args: getParamNames(hubServer[fun])}
                }
            }
        }
    }


    for (var hubName in hubsInfo) {
        if (hubsInfo.hasOwnProperty(hubName)) {
            var title = document.createElement("h2");
            document.body.appendChild(title);
            title.innerHTML = hubName;
            var table = document.createElement("TABLE");
            document.body.appendChild(table);
            var header = table.createTHead()
            var row = header.insertRow(-1);
            row.insertCell(-1).innerHTML = "<b>Function name</b>";
            row.insertCell(-1).innerHTML = "<b>Args</b>";
            row.insertCell(-1).innerHTML = "<b>Args values</b>";
            row.insertCell(-1).innerHTML = "<b>Send</b>";

            getSortedElements(hubsInfo[hubName]).forEach(function (functionName) {
                var args = hubsInfo[hubName][functionName].args;
                var newRow = table.insertRow(-1);
                newRow.insertCell(-1).innerHTML = functionName;
                newRow.insertCell(-1).innerHTML = hubsInfo[hubName][functionName].args.join("<br>");
                var argsCell = newRow.insertCell(-1);
                var sendButtonCell = newRow.insertCell(-1)
                var sendButton = document.createElement("button")
                sendButton.innerHTML = "Send"
                sendButtonCell.appendChild(sendButton);

                var argsInputs = []
                for (var i = 0; i < args.length; i++) {
                    var input = document.createElement("input");
                    argsCell.appendChild(input);
                    argsInputs.push(input);
                }
                sendButton.argsInputs = argsInputs;
                sendButton.functionName = functionName
                sendButton.hubName = hubName
                sendButton.onclick = function () {
                    var args = this.argsInputs.map(function (input) {
                        return input.value;
                    })
                    var f = hubsApi[this.hubName].server[this.functionName];
                    f.apply(f, args).done(
                        function () {
                            output({Sucess: true, args: arguments});
                        }, function () {
                            output({Sucess: false, args: arguments});
                        }
                    )
                };
            });
        }
    }


    document.body.appendChild(resultPreElement)
</script>
</body>
</html>
