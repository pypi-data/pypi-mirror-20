---
- name: Update the local /etc/hosts with k8sdc hosts and services
  hosts:
    - localhost
  become: yes
  vars_files: 
    - "{{ inventory_dir}}/group_vars/k8sdc.yaml"
  tasks:
    - name: Get hostnames from Solutions
      set_fact:
        hostnames: >-
          {%- for solution in solutions -%}
            {%- if solutions[solution].hostnames is defined -%}
              {%- for hostname in solutions[solution].hostnames -%}
                {{ hostname }}
                {%- if not loop.last -%},{%- endif -%}              
              {%- endfor -%}
              {%- if not loop.last -%},{%- endif -%}
            {%- endif -%}
          {%- endfor -%}


    # TODO: Make this use a VIP provided by keepalived
    - name: Add hosts entries
      lineinfile:
        dest:   /etc/hosts
        state:  present
        line:   "{{ hostvars[groups['k8sdc-nodes'][0]]['ansible_' + interface].ipv4.address }} {{ item }}"
        regexp: "{{ item }}$"
      with_items: hostnames.split(',')[:-1]